<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Problem Tree for {{ project.title }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            gap: 2em;
            margin: 2em;
            padding: 1em;
        }
        .main-content { flex: 3; }
        .sidebar { flex: 2; max-width: 400px; }

        /* === D3.js Tree Styles === */
        .tree-container .card-body {
            padding: 0;
            margin: 0;
            overflow: hidden; /* Hide overflow */
        }

        #d3-tree-svg {
            width: 100%;
            height: 600px; /* Set a fixed height */
            cursor: move; /* Grab cursor for panning */
            background-color: #fdfdfd;
        }

        /* Style for the links (lines) */
        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
        }

        /* Base node style */
        .node circle {
            stroke: #333;
            stroke-width: 1.5px;
        }

        .node text {
            font: 12px sans-serif;
            fill: #222;
        }

        /* Specific node colors based on problem type */
        .node.type-CORE circle { fill: #ffc107; }
        .node.type-EFFECT circle { fill: #f8d7da; }
        .node.type-CAUSE circle { fill: #cfe2ff; }

        /* Custom color from our form */
        .node.type-CUSTOM circle {
            /* We will set this with a .style('fill') in D3 */
            stroke: #000;
            stroke-width: 2.5px; /* Highlight custom-colored nodes */
        }

        /* D3 Tooltip (we'll reuse the stakeholder one) */
        .d3-tooltip {
            position: absolute;
            text-align: left;
            padding: 8px 12px;
            font: 12px sans-serif;
            background: #222;
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
        }

        /* Manage Problems List Style */
         .list-group-item span {
             flex-grow: 1;
             margin-right: 1rem;
         }
         .list-group-item form {
             flex-shrink: 0;
         }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>Problem Tree: {{ project.title }}</h1>

        <div class="tree-container card shadow-sm mb-4">
            <div class="card-body">
                <svg id="d3-tree-svg"></svg>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header"><h2 class="h5 mb-0">Manage Problems</h2></div>
            <div class="card-body p-0">
                {% if all_problems %}
                <ul class="list-group list-group-flush">
                    {% for problem in all_problems %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <strong class="me-2">[{{ problem.get_problem_type_display }}]</strong>
                            {{ problem.description }}
                            {% if problem.parent %}
                                <small class="text-muted ms-2">(Child of: {{ problem.parent.description|truncatechars:30 }})</small>
                            {% endif %}
                        </span>
                        <form action="{% url 'delete_problem' problem.id %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this problem? This cannot be undone.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="p-3 text-muted mb-0">No problems added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card shadow-sm">
             <div class="card-header"><h2 class="h5 mb-0">Add New Problem / Cause / Effect</h2></div>
             <div class="card-body">
                 <form method="post">
                     {% csrf_token %}
                     {{ form.as_p }}
                     <button type="submit" class="btn btn-primary w-100 mt-3">Add to Analysis</button>
                 </form>
             </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header"><h2 class="h5 mb-0">Actions</h2></div>
            <div class="card-body d-grid gap-2">
                <a href="{% url 'download_problem_tree_png' project_id=project.id %}" class="btn btn-outline-secondary">Download Tree as PNG</a>
            </div>
        </div>
    </div>

    <div class="d3-tooltip"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Get the data URL from Django
        const dataUrl = "{% url 'problem_tree_data_api' project.id %}";

        // Set up SVG dimensions
        const svg = d3.select("#d3-tree-svg");
        const width = svg.node().getBoundingClientRect().width;
        const height = svg.node().getBoundingClientRect().height;
        const g = svg.append("g"); // This is the group we'll zoom/pan

        // Select the tooltip
        const tooltip = d3.select(".d3-tooltip");

        // Set up the tree layout
        // We use 'dy' and 'dx' to control spacing.
        // 'dx' is node-to-node horizontal, 'dy' is level-to-level vertical.
        const treeLayout = d3.tree().size([width, height * 0.8]) // Use 80% of height to leave margin
            .nodeSize([80, 120]); // [node-width-spacing, level-depth-spacing]

        // This is a function to create the diagonal "elbow" paths for links
        const linkGenerator = d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y);

        // Load the data and draw the tree
        d3.json(dataUrl).then(function(data) {
            if (!data || !data.children || data.children.length === 0) {
                g.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .text("No problems added yet. Add one in the sidebar!");
                return;
            }

            // 1. Create the hierarchy
            const root = d3.hierarchy(data);

            // 2. Compute the layout
            // We tell it where to start. We'll offset 'g' to center it.
            const treeData = treeLayout(root);

            // 3. Find the center x-position to center the root node
            const rootNode = treeData.descendants()[0];
            const initialXOffset = (width / 2) - rootNode.x;
            const initialYOffset = 50; // Add some padding from the top

            // Apply the initial transform to our main group
            g.attr("transform", `translate(${initialXOffset}, ${initialYOffset})`);

            // 4. Draw the Links
            g.selectAll(".link")
                .data(treeData.links())
                .join("path")
                .attr("class", "link")
                .attr("d", d => linkGenerator({source: d.source, target: d.target}));

            // 5. Draw the Nodes
            const node = g.selectAll(".node")
                .data(treeData.descendants())
                .join("g")
                // Add a class for type, and a class if it has a custom color
                .attr("class", d => `node type-${d.data.type} ${d.data.color ? 'type-CUSTOM' : ''}`)
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .style("cursor", "pointer")
                .on("click", (event, d) => {
                    // This is our hook for the edit modal!
                    if (d.data.id && d.data.id !== 'project-root') {
                        console.log("Clicked on node ID:", d.data.id);
                        // In the future: openEditModal(d.data.id);
                    }
                })
                .on("mouseover", (event, d) => {
                    if (d.data.id !== 'project-root') {
                        tooltip.transition().style("opacity", .9);
                        tooltip.html(`
                            <strong>${d.data.type}</strong>
                            <hr style="margin: 2px 0; opacity: 0.3;">
                            ${d.data.name}
                        `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", () => {
                    tooltip.transition().style("opacity", 0);
                });

            // Add circles to the nodes
            node.append("circle")
                .attr("r", 12)
                .style("fill", d => d.data.color ? d.data.color : null); // Apply custom color

            // Add labels to the nodes
            node.append("text")
                .text(d => d.data.name)
                .attr("dy", "0.31em") // Vertically center
                .attr("y", 25) // Position below the circle
                .attr("text-anchor", "middle")
                .style("font-weight", "bold");
        });

        // --- Zoom and Pan ---
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3]) // Min/max zoom
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

    </script>

</body>
</html>