<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Problem Tree for {{ project.title }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .page-container {
            display: flex;
            gap: 2em;
            margin: 2em;
            padding: 1em;
        }

        .main-content {
            flex: 3;
        }
        .sidebar {
            flex: 2;
            max-width: 400px;
        }

        /* === D3.js Tree Styles === */

        /* FIX: Make tree-container the relative parent for the arrow */
        .tree-container {
            position: relative; /* This is the anchor for the arrow */
        }

        .tree-container .card-body {
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        /* FIX: Added padding-right to the SVG to make room for arrow */
        #d3-tree-svg {
            width: 100%;
            min-height: 800px;
            background-color: #fdfdfd;
            padding-right: 50px; /* Space for the arrow */
            box-sizing: border-box; /* Include padding in the width */
        }

        /* --- FIX: New arrow style --- */
        .why-arrow {
            position: absolute; /* Positioned relative to .tree-container */
            right: 15px;        /* Stick to the right edge of the card */
            top: 10%;
            height: 80%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e67e22;
            z-index: 10;
        }
        .why-arrow span {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin-bottom: 10px;
        }
        .why-arrow .arrow-line {
            width: 4px;
            background-color: #e67e22;
            flex-grow: 1;
        }
        .why-arrow .arrow-head {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #e67e22;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
        }

        .node rect {
            stroke: #333;
            stroke-width: 1.5px;
            stroke-opacity: 0.8;
        }
        .node.type-CORE rect { fill: #ffc107; }
        .node.type-EFFECT rect { fill: #f8d7da; }
        .node.type-CAUSE rect { fill: #cfe2ff; }
        .node.type-CUSTOM rect {
            stroke: #000;
            stroke-width: 2px;
        }

        .d3-tooltip {
            position: absolute;
            text-align: left;
            padding: 8px 12px;
            font: 12px sans-serif;
            background: #222;
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
        }

        .list-group-item span {
             flex-grow: 1;
             margin-right: 1rem;
         }
        .list-group-item form {
             flex-shrink: 0;
         }
    </style>
</head>
<body class="bg-light">

    <div class="page-container">

        <div class="main-content">
            <h1>Problem Tree: {{ project.title }}</h1>

            <div id="tree-to-download" class="tree-container card shadow-sm mb-4">
                <div class="card-body">
                    <svg id="d3-tree-svg"></svg>
                </div>

                <div class="why-arrow">
                    <div class="arrow-head"></div>
                    <div class="arrow-line"></div>
                    <span>WHY?</span>
                </div>
            </div>


        </div>

        <div class="sidebar">
            <div class="card shadow-sm">
                 <div class="card-header"><h2 class="h5 mb-0">Add New Problem / Cause / Effect</h2></div>
                 <div class="card-body">
                     <form method="post">
                         {% csrf_token %}
                         {{ form.as_p }}
                         <button type="submit" class="btn btn-primary w-100 mt-3">Add to Analysis</button>
                     </form>
                 </div>
            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-header"><h2 class="h5 mb-0">Actions</h2></div>
                <div class="card-body d-grid gap-2">
                    <button type="button" onclick="downloadTreeAsPNG()" class="btn btn-outline-secondary">Download Tree as PNG</button>                </div>
            </div>
        </div></div><div class="d3-tooltip"></div>

    <div class="modal fade" id="nodeActionModal" tabindex="-1" aria-labelledby="nodeActionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeActionModalLabel">Node Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>What would you like to do with this item?</p>
                    <h6 id="modalNodeName" class="fw-bold text-dark border p-2 rounded bg-light"></h6>
                </div>
                <div class="modal-footer justify-content-between">
                    <form id="modalDeleteForm" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this? This cannot be undone.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Delete This Item</button>
                    </form>
                    <button type="button" class="btn btn-primary" id="modalEditButton">Edit This Item</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Get the data URL from Django
    const dataUrl = "{% url 'problem_tree_data_api' project.id %}";
    // Create a template for the delete URL, using a placeholder '999'
    const deleteUrlTemplate = "{% url 'delete_problem' 999 %}";

    // Get the modal instance
    const nodeActionModal = new bootstrap.Modal(document.getElementById('nodeActionModal'));

    // Set up SVG dimensions
    const svg = d3.select("#d3-tree-svg");
    const width = svg.node().getBoundingClientRect().width;
    const g = svg.append("g"); // This is the main container

    // Define Node Size
    const nodeWidth = 160;
    const nodeHeight = 70;
    const halfNodeHeight = nodeHeight / 2;

    // Select the tooltip
    const tooltip = d3.select(".d3-tooltip");

    // Set up the tree layout generator
    const treeLayout = d3.tree()
        .nodeSize([nodeWidth + 20, nodeHeight + 80]); // Spacing

    // Link generator function
    const linkGenerator = d3.linkVertical()
        .x(d => d.x)
        .y(d => d.y);

    // Load the data and draw the tree
    d3.json(dataUrl).then(function(data) {

        if (!data || data.no_core_problem) {
            let message = data && data.no_core_problem ?
                "Please add a 'Core Problem' to start building the tree." :
                "No problems added yet. Add one in the sidebar!";

            // Set SVG height to default and show message
            svg.attr("height", 600);
            g.append("text")
                .attr("x", width / 2)
                .attr("y", 300)
                .attr("text-anchor", "middle")
                .text(message);
            return;
        }

        // --- 1. Set up the hierarchies ---
        const causeHierarchy = d3.hierarchy(data, d => d.causes);
        const effectHierarchy = d3.hierarchy(data, d => d.effects);
        const causeTree = treeLayout(causeHierarchy);
        const effectTree = treeLayout(effectHierarchy);

        // --- 2. FIX: Calculate total tree height ---
        let maxEffectY = 0;
        effectTree.descendants().forEach(d => {
            if (d.y > maxEffectY) maxEffectY = d.y;
        });

        let maxCauseY = 0;
        causeTree.descendants().forEach(d => {
            if (d.y > maxCauseY) maxCauseY = d.y;
        });

        // Calculate total height needed. Add nodeHeight + 100px padding
        const totalTreeHeight = maxEffectY + maxCauseY + nodeHeight + 100;
        const minHeight = 600; // The default minimum height

        // Set the SVG height dynamically
        svg.attr("height", Math.max(totalTreeHeight, minHeight));

        // --- 3. FIX: Set the correct starting Y position ---
        const initialXOffset = width / 2;
        // This pushes the whole tree down so the "effects" are never cut off
        const initialYOffset = maxEffectY + halfNodeHeight + 50; // 50px top padding

        g.attr("transform", `translate(${initialXOffset}, ${initialYOffset})`);


        // --- 4. Draw helper function ---
        function drawTree(nodes, links, yDirection) {

            g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(links)
                .join("path")
                .attr("class", "link")
                .attr("d", d => linkGenerator({
                    source: {
                        x: d.source.x,
                        y: (d.source.y * yDirection) + (halfNodeHeight * yDirection)
                    },
                    target: {
                        x: d.target.x,
                        y: (d.target.y * yDirection) - (halfNodeHeight * yDirection)
                    }
                }));

            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", d => `node type-${d.data.type} ${d.data.color ? 'type-CUSTOM' : ''}`)
                .attr("transform", d => `translate(${d.x}, ${d.y * yDirection})`)
                .style("cursor", "pointer")
                .on("click", (event, d) => {
    if (d.data.id && d.data.id !== 'project-root') {
        const nodeId = d.data.id;
        const deleteUrl = deleteUrlTemplate.replace('999', nodeId);
        document.getElementById('modalNodeName').textContent = d.data.name;

        // --- THIS IS THE FIX ---
        document.getElementById('modalDeleteForm').action = deleteUrl; // Use the correct variable

        document.getElementById('modalEditButton').onclick = () => {
            alert("Edit functionality will be added in the next step!");
            nodeActionModal.hide();
        };
        nodeActionModal.show();
    }
})
                .on("mouseover", (event, d) => {
                    if (d.data.id) {
                        tooltip.transition().style("opacity", .9);
                        tooltip.html(`<strong>${d.data.type}</strong><hr style="margin: 2px 0; opacity: 0.3;">${d.data.name}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", () => {
                    tooltip.transition().style("opacity", 0);
                });

            node.append("rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight)
                .attr("x", -nodeWidth / 2)
                .attr("y", -nodeHeight / 2)
                .attr("rx", 5)
                .attr("ry", 5)
                .style("fill", d => d.data.color ? d.data.color : null);

            node.append("foreignObject")
                .attr("width", nodeWidth - 10)
                .attr("height", nodeHeight - 10)
                .attr("x", -nodeWidth / 2 + 5)
                .attr("y", -nodeHeight / 2 + 5)
                .append("xhtml:div")
                .style("width", "100%").style("height", "100%")
                .style("display", "flex").style("align-items", "center")
                .style("justify-content", "center").style("text-align", "center")
                .style("font-size", "13px").style("color", "#212529")
                .style("font-weight", "600").style("overflow-wrap", "break-word")
                .html(d => d.data.name);
        }

        // --- 5. Draw Both Trees ---
        drawTree(causeTree.descendants(), causeTree.links(), 1);
        drawTree(effectTree.descendants().slice(1), effectTree.links(), -1);

    }); // End of d3.json()

    function downloadTreeAsPNG() {
        // 1. Select the ENTIRE card using the ID we added
        const treeContainer = document.getElementById("tree-to-download");

        // 2. Use html2canvas on that container
        html2canvas(treeContainer, {
            scale: 2 // Increase resolution
        }).then(canvas => {
            // 3. Create a download link
            const link = document.createElement('a');
            link.download = 'problem-tree.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

</script>
</body>
</html>