{% extends "base.html" %}
{% block title %}Project Overview â€” {{ project.title }}{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">{{ project.title }} â€” Project Info</h3>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">â† Back to Dashboard</a>
  </div>
  <p class="text-muted">Fill in each section below. You can save individually or use â€œSave & Continueâ€ at the bottom.</p>


  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-danger">A1 â€” Problem</h5>
        <textarea id="boxA1" class="form-control" rows="6">{{ overview.A1.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="A1">Save</button></div>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="text-danger">A2 â€” Context</h5>
        <textarea id="boxA2" class="form-control" rows="5">{{ overview.A2.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="A2">Save</button></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-primary">B1 â€” Solution</h5>
        <textarea id="boxB1" class="form-control" rows="6">{{ overview.B1.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="B1">Save</button></div>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="text-primary">B2 â€” Activities</h5>
        <textarea id="boxB2" class="form-control" rows="4">{{ overview.B2.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="B2">Save</button></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C1 â€” Stakeholders</h5>
        <textarea id="boxC1" class="form-control" rows="5">{{ overview.C1.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="C1">Save</button></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C2 â€” Resources</h5>
        <textarea id="boxC2" class="form-control" rows="5">{{ overview.C2.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="C2">Save</button></div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C3 â€” Dissemination</h5>
        <textarea id="boxC3" class="form-control" rows="5">{{ overview.C3.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="C3">Save</button></div>
      </div>
    </div>

    <div class="col-md-12">
      <div class="card p-3 mb-3">
        <h5 class="text-warning">D2 â€” Impact on SDGs</h5>
        <textarea id="boxD2" class="form-control" rows="3">{{ overview.D2.text }}</textarea>
        <div class="mt-2 text-end"><button class="btn btn-sm btn-primary save-box" data-box="D2">Save</button></div>
      </div>
    </div>
  </div>
<div class="text-end mt-4">
    <button id="saveAllBtn" class="btn btn-success">
      ğŸ’¾ Save & Continue to Dashboard
    </button>
  </div>
</div>
<div class="text-end mt-3">
  <button id="downloadOverview" class="btn btn-outline-secondary">ğŸ“„ Download as PDF</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const boxes = ["A1","A2","B1","B2","C1","C2","C3","D2"];
  const debounceTimers = {};
  const saveQueue = new Set();

  // âœ… Toast setup
  const toast = document.createElement("div");
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.right = "20px";
  toast.style.background = "#198754";
  toast.style.color = "white";
  toast.style.padding = "8px 16px";
  toast.style.borderRadius = "8px";
  toast.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  toast.style.display = "none";
  toast.style.zIndex = "9999";
  document.body.appendChild(toast);

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 2000);
  }

  async function saveBox(box, text) {
    try {
      const res = await fetch("{% url 'project_overview' project.id %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ box, text }),
      });
      const data = await res.json();
      if (data.status === "ok") {
        showToast("Saved âœ“");
      }
    } catch (err) {
      console.error("Save failed:", err);
    }
  }

  // Auto-save when typing stops
  boxes.forEach((b) => {
    const el = document.getElementById("box" + b);
    el?.addEventListener("input", () => {
      clearTimeout(debounceTimers[b]);
      debounceTimers[b] = setTimeout(() => {
        const text = el.value;
        saveBox(b, text);
      }, 1500); // 1.5 seconds after stop typing
    });
  });

  // âœ… Manual save all (same as before)
  document.getElementById("saveAllBtn").addEventListener("click", async () => {
    for (const b of boxes) {
      const text = document.getElementById("box" + b).value;
      await saveBox(b, text);
    }
    showToast("All saved âœ“");
    window.location.href = "{% url 'dashboard' %}";
  });
});
</script>

{% endblock %}