{% extends "base.html" %}
{% block title %}Project Overview ‚Äî {{ project.title }}{% endblock %}
{% block content %}
<div class="container py-4" id="overviewContainer">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">{{ project.title }} ‚Äî Project Info</h3>
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
  </div>
  <p class="text-muted">
    Fill in each section below. Text auto-saves every few seconds.
    You can also use ‚ÄúSave & Continue‚Äù or ‚ÄúDownload as PDF‚Äù.
  </p>

  <!-- üî∏ A/B Section -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-danger">A1 ‚Äî Problem</h5>
        <textarea id="boxA1" class="form-control" rows="6">{{ overview.A1.text }}</textarea>
      </div>
      <div class="card p-3 mb-3">
        <h5 class="text-danger">A2 ‚Äî Context</h5>
        <textarea id="boxA2" class="form-control" rows="5">{{ overview.A2.text }}</textarea>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-primary">B1 ‚Äî Solution</h5>
        <textarea id="boxB1" class="form-control" rows="6">{{ overview.B1.text }}</textarea>
      </div>
      <div class="card p-3 mb-3">
        <h5 class="text-primary">B2 ‚Äî Activities</h5>
        <textarea id="boxB2" class="form-control" rows="4">{{ overview.B2.text }}</textarea>
      </div>
    </div>

    <!-- üîπ C Section -->
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C1 ‚Äî Stakeholders</h5>
        <textarea id="boxC1" class="form-control" rows="5">{{ overview.C1.text }}</textarea>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C2 ‚Äî Resources</h5>
        <textarea id="boxC2" class="form-control" rows="5">{{ overview.C2.text }}</textarea>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h5 class="text-purple">C3 ‚Äî Dissemination</h5>
        <textarea id="boxC3" class="form-control" rows="5">{{ overview.C3.text }}</textarea>
      </div>
    </div>

    <!-- üî∏ D Section -->
    <div class="col-md-12">
      <div class="card p-3 mb-3">
        <h5 class="text-warning">D2 ‚Äî Impact on SDGs</h5>
        <textarea id="boxD2" class="form-control" rows="3">{{ overview.D2.text }}</textarea>
      </div>
    </div>
  </div>

  <!-- Buttons -->
  <div class="text-end mt-4 d-flex justify-content-end gap-2">
    <button id="downloadOverview" class="btn btn-outline-secondary">üìÑ Download as PDF</button>
    <button id="saveAllBtn" class="btn btn-success">üíæ Save & Continue to Dashboard</button>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const boxes = ["A1","A2","B1","B2","C1","C2","C3","D2"];
  const debounceTimers = {};

  // ‚úÖ Toast setup
  const toast = document.createElement("div");
  Object.assign(toast.style, {
    position: "fixed", bottom: "20px", right: "20px", background: "#198754",
    color: "#fff", padding: "8px 16px", borderRadius: "8px", boxShadow: "0 2px 8px rgba(0,0,0,0.2)",
    display: "none", zIndex: "9999"
  });
  document.body.appendChild(toast);

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 2000);
  }

  async function saveBox(box, text) {
    try {
      const res = await fetch("{% url 'project_overview' project.id %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ box, text }),
      });
      const data = await res.json();
      if (data.status === "ok") showToast("Saved ‚úì");
    } catch (err) {
      console.error("Save failed:", err);
    }
  }

  // üß† Auto-save after typing stops
  boxes.forEach((b) => {
    const el = document.getElementById("box" + b);
    el?.addEventListener("input", () => {
      clearTimeout(debounceTimers[b]);
      debounceTimers[b] = setTimeout(() => saveBox(b, el.value), 1500);
    });
  });

  // üíæ Save all and go back
  document.getElementById("saveAllBtn").addEventListener("click", async () => {
    for (const b of boxes) {
      await saveBox(b, document.getElementById("box" + b).value);
    }
    showToast("All saved ‚úì");
    setTimeout(() => (window.location.href = "{% url 'dashboard' %}"), 1000);
  });

  // üìÑ Download as PDF
  const downloadBtn = document.getElementById("downloadOverview");
  downloadBtn.addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "px", format: "a4" });
    const board = document.getElementById("overviewContainer");

    const canvas = await html2canvas(board, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const pageWidth = doc.internal.pageSize.getWidth();
    const imgHeight = (canvas.height * pageWidth) / canvas.width;

    // Add project title + date
    doc.setFontSize(16);
    doc.text("{{ project.title }} ‚Äî Project Overview", 20, 25);
    doc.setFontSize(10);
    doc.text("Exported on: " + new Date().toLocaleString(), 20, 40);

    doc.addImage(imgData, "PNG", 0, 50, pageWidth, imgHeight - 30);
    doc.save("project_overview_{{ project.id }}.pdf");
  });
});
</script>
{% endblock %}
