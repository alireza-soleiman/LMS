{% extends "base.html" %}
{% load static %}
{% block title %}SRF Playing Cards ‚Äî {{ project.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-8">
      <h3>üé¥ SRF Method ‚Äî Playing Cards</h3>
      <p class="text-muted">
        Drag the indicator cards to rank them by importance.
        Add white cards to show importance gaps.
        You can also merge indicators with equal importance.
      </p>

      <!-- üéØ Buttons -->
      <div class="text-center mb-3">
        <button id="addWhiteCard" class="btn btn-outline-secondary btn-sm">‚¨ú Add White Card (Gap)</button>
        <button id="mergeCards" class="btn btn-outline-primary btn-sm">üîó Merge Selected (Equal Importance)</button>
      </div>

      <!-- üé¥ Main board -->
      <div id="board" class="p-3 bg-light rounded shadow-sm d-flex flex-column gap-3">
        {% for ind in indicators %}
        <div class="card srf-card" data-id="{{ ind.id }}">
          <div class="card-body p-2">
            <h6 class="mb-1">{{ ind.name }}</h6>
            <small class="text-muted">{{ ind.criterion }}</small><br>
            <small>{{ ind.description|truncatewords:10 }}</small>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- üí° Right panel -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üí° SRF Weight Summary</h5>
          <div id="summaryTable" class="small"></div>
          <button id="saveBtn" class="btn btn-primary w-100 mt-3">üíæ Save SRF Weights</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üé® Styles -->
<style>
#board {
  min-height: 300px;
}
.srf-card {
  cursor: grab;
  border-radius: 10px;
  border: 2px solid #ddd;
  background-color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.15s ease;
}
.srf-card.dragging {
  opacity: 0.6;
  transform: scale(1.05);
}
.white-card {
  text-align: center;
  padding: 10px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: repeating-linear-gradient(
    45deg,
    #fff,
    #fff 10px,
    #f0f0f0 10px,
    #f0f0f0 20px
  );
  cursor: grab;
}
.group-card {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  border: 2px solid #aaa;
  border-radius: 10px;
  padding: 6px;
  background: #f9f9f9;
}
.srf-card.selected {
  border-color: #007bff;
  box-shadow: 0 0 6px #007bff;
}
</style>
<!-- üì¶ SortableJS + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const board = document.getElementById("board");
  const addWhiteBtn = document.getElementById("addWhiteCard");
  const mergeBtn = document.getElementById("mergeCards");

  // ‚úÖ Enable drag and drop
  Sortable.create(board, {
    animation: 150,
    ghostClass: 'dragging',
    handle: '.srf-card, .white-card, .group-card',
  });

  // ‚úÖ Add white card
  addWhiteBtn.addEventListener("click", () => {
    const white = document.createElement("div");
    white.className = "white-card";
    white.textContent = "‚¨ú White Card (Gap)";
    board.appendChild(white);
  });

  // ‚úÖ Select cards by clicking
  board.addEventListener("click", e => {
    const card = e.target.closest(".srf-card");
    if (!card) return;
    card.classList.toggle("selected");
  });

  // ‚úÖ Merge selected indicator cards
  mergeBtn.addEventListener("click", () => {
    const selected = [...board.querySelectorAll(".srf-card.selected")];
    if (selected.length < 2) {
      alert("Select at least 2 indicator cards to merge!");
      return;
    }

    const group = document.createElement("div");
    group.className = "group-card";
    group.innerHTML = `<div class="text-muted small mb-1">‚öñÔ∏è Equal Importance Group</div>`;

    const first = selected[0];
    board.insertBefore(group, first);
    selected.forEach(card => {
      card.classList.remove("selected");
      group.appendChild(card);
    });

    Sortable.create(group, {
      group: "shared",
      animation: 150,
      handle: '.srf-card',
    });
  });

  // === üé® COLOR PICKER (with emoji icon) + PNG DOWNLOAD ===
  function addColorPickers() {
    board.querySelectorAll(".srf-card").forEach(card => {
      if (card.querySelector(".color-btn")) return;

      // Create invisible color input
      const colorInput = document.createElement("input");
      colorInput.type = "color";
      colorInput.className = "color-input";
      colorInput.value = card.dataset.color || "#ffffff";
      colorInput.style.display = "none";

      // Create emoji button that triggers color input
      const emojiBtn = document.createElement("button");
      emojiBtn.className = "btn btn-sm btn-outline-secondary color-btn";
      emojiBtn.innerHTML = "üé®";
      emojiBtn.title = "Change card color";
      emojiBtn.style.position = "absolute";
      emojiBtn.style.top = "5px";
      emojiBtn.style.right = "5px";
      emojiBtn.style.padding = "2px 6px";
      emojiBtn.style.fontSize = "14px";
      emojiBtn.style.lineHeight = "1";
      emojiBtn.style.borderRadius = "6px";

      emojiBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        colorInput.click(); // open native color picker
      });

      colorInput.addEventListener("input", (e) => {
        const color = e.target.value;
        card.style.backgroundColor = color;
        card.dataset.color = color;
        saveCardColors();
      });

      card.style.position = "relative";
      card.appendChild(emojiBtn);
      card.appendChild(colorInput);
    });
  }

  // üíæ Save colors
  function saveCardColors() {
    const colors = {};
    board.querySelectorAll(".srf-card").forEach(card => {
      colors[card.dataset.id || card.innerText.trim()] = card.dataset.color || "#ffffff";
    });
    localStorage.setItem("cardColors", JSON.stringify(colors));
  }

  // üîÅ Restore colors
  function loadCardColors() {
    const saved = JSON.parse(localStorage.getItem("cardColors") || "{}");
    board.querySelectorAll(".srf-card").forEach(card => {
      const key = card.dataset.id || card.innerText.trim();
      if (saved[key]) {
        card.style.backgroundColor = saved[key];
        card.dataset.color = saved[key];
      }
    });
  }

  // üì∏ Download as PNG
  const downloadBtn = document.createElement("button");
  downloadBtn.className = "btn btn-success mt-3";
  downloadBtn.innerHTML = "üì∏ Download Cards as PNG";
  document.querySelector(".col-lg-8").appendChild(downloadBtn);

  downloadBtn.addEventListener("click", async () => {
    downloadBtn.disabled = true;
    downloadBtn.innerText = "üì∏ Generating...";
    try {
      const canvas = await html2canvas(board, { scale: 2, backgroundColor: "#ffffff" });
      const link = document.createElement("a");
      link.download = `project_{{ project.id }}_srf_cards.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    } catch (err) {
      alert("Error generating PNG: " + err.message);
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.innerText = "üì∏ Download Cards as PNG";
    }
  });

  // Initialize
  addColorPickers();
  loadCardColors();
});
</script>

{% endblock %}
