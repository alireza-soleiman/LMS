{% extends "base.html" %}
{% load static %}
{% block title %}SRF Playing Cards ‚Äî {{ project.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-8">
      <h3>üé¥ SRF Method ‚Äî Playing Cards</h3>
      <p class="text-muted">Drag indicators into order and use ‚Äúwhite cards‚Äù to represent importance gaps.</p>

      <div id="board" class="p-3 bg-light rounded shadow-sm d-flex flex-column gap-3">
        {% for ind in indicators %}
        <div class="card srf-card" data-id="{{ ind.id }}">
          <div class="card-body p-2">
            <h6 class="mb-1">{{ ind.name }}</h6>
            <small class="text-muted">{{ ind.criterion }}</small><br>
            <small>{{ ind.description|truncatewords:10 }}</small>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="text-center mt-3">
        <button id="addWhiteCard" class="btn btn-outline-secondary btn-sm">‚ûï Add White Card (Gap)</button>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üí° SRF Weight Summary</h5>
          <div id="summaryTable" class="small"></div>
          <button id="saveBtn" class="btn btn-primary w-100 mt-3">üíæ Save SRF Weights</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>

  .srf-card {
    cursor: grab;
    border: 2px solid #ddd;
    border-radius: 12px;
    background: white;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .srf-card.dragging {
    opacity: 0.6;
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .white-card {
    background: repeating-linear-gradient(
      45deg, #fff, #fff 10px, #f0f0f0 10px, #f0f0f0 20px
    );
    border: 2px dashed #bbb;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #777;
  }

</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const board = document.getElementById("board");
  const saveBtn = document.getElementById("saveBtn");
  const summaryTable = document.getElementById("summaryTable");
  const addWhiteCardBtn = document.getElementById("addWhiteCard");

  // Make all cards draggable
  function makeDraggable(el) {
    el.setAttribute("draggable", "true");
  }

  board.querySelectorAll(".srf-card").forEach(makeDraggable);

  let dragged = null;

  // --- Drag start / end ---
  board.addEventListener("dragstart", e => {
    if (e.target.matches(".srf-card, .white-card")) {
      dragged = e.target;
      e.target.classList.add("dragging");
    }
  });

  board.addEventListener("dragend", e => {
    if (dragged) dragged.classList.remove("dragging");
    dragged = null;
    updateSummary();
  });

  // --- Drag over handling ---
  board.addEventListener("dragover", e => {
    e.preventDefault();
    const afterElement = getDragAfterElement(board, e.clientY);
    if (afterElement == null) board.appendChild(dragged);
    else board.insertBefore(dragged, afterElement);
  });

  function getDragAfterElement(container, y) {
    const els = [...container.querySelectorAll(".srf-card:not(.dragging), .white-card:not(.dragging)")];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // --- Add draggable white card ---
  addWhiteCardBtn.addEventListener("click", () => {
    const white = document.createElement("div");
    white.className = "white-card";
    white.textContent = "‚¨ú White Card (Gap)";
    makeDraggable(white);
    board.appendChild(white);
    updateSummary();
  });

  // --- Update summary panel ---
  function updateSummary() {
    const cards = board.querySelectorAll(".srf-card, .white-card");
    let html = "<ul class='list-group list-group-flush'>";
    let rank = 1;
    cards.forEach((el) => {
      if (el.classList.contains("srf-card")) {
        html += `<li class='list-group-item small'>${rank++}. ${el.querySelector("h6").textContent}</li>`;
      } else {
        html += `<li class='list-group-item text-center text-muted'>‚¨ú Gap (White Card)</li>`;
      }
    });
    html += "</ul>";
    summaryTable.innerHTML = html;
  }

  updateSummary();

  // --- Save SRF data ---
  saveBtn.addEventListener("click", () => {
    const cards = board.querySelectorAll(".srf-card, .white-card");
    const order = [];
    const white_cards = {};
    let lastIndicator = null;
    let gapCount = 0;

    cards.forEach((el) => {
      if (el.classList.contains("white-card")) {
        gapCount++;
      } else if (el.classList.contains("srf-card")) {
        const id = el.dataset.id;
        if (lastIndicator) white_cards[lastIndicator] = gapCount;
        gapCount = 0;
        order.push(id);
        lastIndicator = id;
      }
    });

    fetch("{% url 'indicator_ranking_view' project.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ order, white_cards }),
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === "success") alert("SRF weights saved successfully!");
      else alert("Error: " + (data.message || "Unknown"));
    })
    .catch(() => alert("Network error."));
  });
});
</script>


{% endblock %}
