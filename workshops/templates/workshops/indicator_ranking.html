{% extends "base.html" %}
{% load static %}
{% block title %}SRF Playing Cards ‚Äî {{ project.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-8">
      <h3>üé¥ SRF Method ‚Äî Playing Cards</h3>
      <p class="text-muted">
        Drag the indicator cards to rank them by importance.
        Add white cards to show importance gaps.
        You can also merge indicators with equal importance.
      </p>

      <!-- üéØ Buttons -->
      <div class="text-center mb-3">
        <button id="addWhiteCard" class="btn btn-outline-secondary btn-sm">‚¨ú Add White Card (Gap)</button>
        <button id="mergeCards" class="btn btn-outline-primary btn-sm">üîó Merge Selected (Equal Importance)</button>
      </div>

      <!-- üé¥ Main board -->
      <div id="board" class="p-3 bg-light rounded shadow-sm d-flex flex-column gap-3">
        {% for ind in indicators %}
        <div class="card srf-card" data-id="{{ ind.id }}">
          <div class="card-body p-2">
            <h6 class="mb-1">{{ ind.name }}</h6>
            <small class="text-muted">{{ ind.criterion }}</small><br>
            <small>{{ ind.description|truncatewords:10 }}</small>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- üí° Right panel -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üí° SRF Weight Summary</h5>
          <div id="summaryTable" class="small"></div>
          <button id="saveBtn" class="btn btn-primary w-100 mt-3">üíæ Save SRF Weights</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üé® Styles -->
<style>
#board {
  min-height: 300px;
}
.srf-card {
  cursor: grab;
  border-radius: 10px;
  border: 2px solid #ddd;
  background-color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.15s ease;
}
.srf-card.dragging {
  opacity: 0.6;
  transform: scale(1.05);
}
.white-card {
  text-align: center;
  padding: 10px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: repeating-linear-gradient(
    45deg,
    #fff,
    #fff 10px,
    #f0f0f0 10px,
    #f0f0f0 20px
  );
  cursor: grab;
}
.group-card {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  border: 2px solid #aaa;
  border-radius: 10px;
  padding: 6px;
  background: #f9f9f9;
}
.srf-card.selected {
  border-color: #007bff;
  box-shadow: 0 0 6px #007bff;
}
</style>

<!-- üì¶ SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const board = document.getElementById("board");
  const addWhiteBtn = document.getElementById("addWhiteCard");
  const mergeBtn = document.getElementById("mergeCards");

  // ‚úÖ Enable main drag-and-drop
  Sortable.create(board, {
    animation: 150,
    ghostClass: 'dragging',
    handle: '.srf-card, .white-card, .group-card',
  });

  // ‚úÖ Add white card
  addWhiteBtn.addEventListener("click", () => {
    const white = document.createElement("div");
    white.className = "white-card";
    white.textContent = "‚¨ú White Card (Gap)";
    board.appendChild(white);
  });

  // ‚úÖ Select indicator cards by clicking
  board.addEventListener("click", e => {
    const card = e.target.closest(".srf-card");
    if (!card) return;
    card.classList.toggle("selected");
  });

  // ‚úÖ Merge selected indicator cards into one draggable group
  mergeBtn.addEventListener("click", () => {
    const selected = [...board.querySelectorAll(".srf-card.selected")];
    if (selected.length < 2) {
      alert("Select at least 2 indicator cards to merge!");
      return;
    }

    // Create the group container
    const group = document.createElement("div");
    group.className = "group-card";
    group.innerHTML = `<div class="text-muted small mb-1">‚öñÔ∏è Equal Importance Group</div>`;

    // Determine where to insert the group (before the first selected card)
    const first = selected[0];
    board.insertBefore(group, first);

    // Move selected cards into the group
    selected.forEach(card => {
      card.classList.remove("selected");
      group.appendChild(card);
    });

    // Make the group itself draggable
    Sortable.create(group, {
      group: "shared",
      animation: 150,
      handle: '.srf-card',
    });
  });

  // ‚úÖ Make the board sortable after groups exist
  Sortable.create(board, {
    animation: 150,
    handle: '.srf-card, .white-card, .group-card',
    ghostClass: 'dragging',
  });
});
</script>


{% endblock %}
