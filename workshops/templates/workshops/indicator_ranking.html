{% extends "base.html" %}
{% load static %}
{% block title %}SRF Playing Cards â€” {{ project.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-lg-8">
      <h3>ğŸ´ SRF Method â€” Playing Cards</h3>
    <hr class="my-4">
<div class="alert alert-info">
  <h5>ğŸ§© How the SRF (Simos) Method Works</h5>
  <p>
    In this step, you <strong>rank indicators</strong> by dragging their cards from top (most important)
    to bottom (least important). If two indicators are equally important,
    <strong>merge them into a group</strong> using â€œğŸ”— Merge Selectedâ€.
  </p>
  <p>
    Use <strong>â¬œ White Cards</strong> to show importance gaps between groups.
    Each white card represents a step increase in perceived importance.
  </p>
  <p>
    When you click <strong>ğŸ’¾ Save SRF Weights</strong>, the system calculates weights automatically:
    it assigns scores based on your order and gaps, then normalizes them so total weight = 1.0.
  </p>
  <p class="mb-0">
    This method is part of the <em>Revised Simos procedure</em> (SRF),
    often used in Multi-Criteria Decision Making (MCDM) to turn subjective rankings into quantitative weights.
  </p>
</div>


      <!-- ğŸ¯ Buttons -->
      <div class="text-center mb-3">
        <button id="addWhiteCard" class="btn btn-outline-secondary btn-sm">â¬œ Add White Card (Gap)</button>
        <button id="mergeCards" class="btn btn-outline-primary btn-sm">ğŸ”— Merge Selected (Equal Importance)</button>
          <a href="{% url 'workshop_list' project.id %}" class="btn btn-outline-secondary px-3">
      â† Back to Workshops
    </a>
      </div>

      <!-- ğŸ´ Main board -->
      <div id="board" class="p-3 bg-light rounded shadow-sm d-flex flex-column gap-3">
        {% for ind in indicators %}
        <div class="card srf-card" data-id="{{ ind.id }}">
          <div class="card-body p-2">
            <h6 class="mb-1">{{ ind.name }}</h6>
            <small class="text-muted">{{ ind.criterion }}</small><br>
            <small>{{ ind.description|truncatewords:10 }}</small>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>


    <!-- ğŸ’¡ Right panel -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">ğŸ’¡ SRF Weight Summary</h5>
          <div id="summaryTable" class="small"></div>
          <button id="saveBtn" class="btn btn-primary w-100 mt-3">ğŸ’¾ Save SRF Weights</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ¨ Styles -->
<style>
#board {
  min-height: 300px;
}
.srf-card {
  cursor: grab;
  border-radius: 10px;
  border: 2px solid #ddd;
  background-color: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.15s ease;
}
.srf-card.dragging {
  opacity: 0.6;
  transform: scale(1.05);
}
.white-card {
  text-align: center;
  padding: 10px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: repeating-linear-gradient(
    45deg,
    #fff,
    #fff 10px,
    #f0f0f0 10px,
    #f0f0f0 20px
  );
  cursor: grab;
}
.group-card {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  border: 2px solid #aaa;
  border-radius: 10px;
  padding: 6px;
  background: #f9f9f9;
}
.srf-card.selected {
  border-color: #007bff;
  box-shadow: 0 0 6px #007bff;
}
</style>
<!-- ğŸ“¦ SortableJS + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const board = document.getElementById("board");
  const addWhiteBtn = document.getElementById("addWhiteCard");
  const mergeBtn = document.getElementById("mergeCards");

  // âœ… Enable drag and drop
  Sortable.create(board, {
    animation: 150,
    ghostClass: 'dragging',
    handle: '.srf-card, .white-card, .group-card',
  });

  // âœ… Add white card
  addWhiteBtn.addEventListener("click", () => {
    const white = document.createElement("div");
    white.className = "white-card";
    white.textContent = "â¬œ White Card (Gap)";
    board.appendChild(white);
  });

  // âœ… Select cards by clicking
  board.addEventListener("click", e => {
    const card = e.target.closest(".srf-card");
    if (!card) return;
    card.classList.toggle("selected");
  });

  // âœ… Merge selected indicator cards
  mergeBtn.addEventListener("click", () => {
    const selected = [...board.querySelectorAll(".srf-card.selected")];
    if (selected.length < 2) {
      alert("Select at least 2 indicator cards to merge!");
      return;
    }

    const group = document.createElement("div");
    group.className = "group-card";
    group.innerHTML = `<div class="text-muted small mb-1">âš–ï¸ Equal Importance Group</div>`;

    const first = selected[0];
    board.insertBefore(group, first);
    selected.forEach(card => {
      card.classList.remove("selected");
      group.appendChild(card);
    });

    Sortable.create(group, {
      group: "shared",
      animation: 150,
      handle: '.srf-card',
    });
  });

  // === ğŸ¨ COLOR PICKER (with emoji icon) + PNG DOWNLOAD ===
  function addColorPickers() {
    board.querySelectorAll(".srf-card").forEach(card => {
      if (card.querySelector(".color-btn")) return;

      // Create invisible color input
      const colorInput = document.createElement("input");
      colorInput.type = "color";
      colorInput.className = "color-input";
      colorInput.value = card.dataset.color || "#ffffff";
      colorInput.style.display = "none";

      // Create emoji button that triggers color input
      const emojiBtn = document.createElement("button");
      emojiBtn.className = "btn btn-sm btn-outline-secondary color-btn";
      emojiBtn.innerHTML = "ğŸ¨";
      emojiBtn.title = "Change card color";
      emojiBtn.style.position = "absolute";
      emojiBtn.style.top = "5px";
      emojiBtn.style.right = "5px";
      emojiBtn.style.padding = "2px 6px";
      emojiBtn.style.fontSize = "14px";
      emojiBtn.style.lineHeight = "1";
      emojiBtn.style.borderRadius = "6px";

      emojiBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        colorInput.click(); // open native color picker
      });

      colorInput.addEventListener("input", (e) => {
        const color = e.target.value;
        card.style.backgroundColor = color;
        card.dataset.color = color;
        saveCardColors();
      });

      card.style.position = "relative";
      card.appendChild(emojiBtn);
      card.appendChild(colorInput);
    });
  }

  // ğŸ’¾ Save colors
  function saveCardColors() {
    const colors = {};
    board.querySelectorAll(".srf-card").forEach(card => {
      colors[card.dataset.id || card.innerText.trim()] = card.dataset.color || "#ffffff";
    });
    localStorage.setItem("cardColors", JSON.stringify(colors));
  }

  // ğŸ” Restore colors
  function loadCardColors() {
    const saved = JSON.parse(localStorage.getItem("cardColors") || "{}");
    board.querySelectorAll(".srf-card").forEach(card => {
      const key = card.dataset.id || card.innerText.trim();
      if (saved[key]) {
        card.style.backgroundColor = saved[key];
        card.dataset.color = saved[key];
      }
    });
  }

  // ğŸ“¸ Download as PNG
  const downloadBtn = document.createElement("button");
  downloadBtn.className = "btn btn-success mt-3";
  downloadBtn.innerHTML = "ğŸ“¸ Download Cards as PNG";
  document.querySelector(".col-lg-8").appendChild(downloadBtn);

  downloadBtn.addEventListener("click", async () => {
    downloadBtn.disabled = true;
    downloadBtn.innerText = "ğŸ“¸ Generating...";
    try {
      const canvas = await html2canvas(board, { scale: 2, backgroundColor: "#ffffff" });
      const link = document.createElement("a");
      link.download = `project_{{ project.id }}_srf_cards.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    } catch (err) {
      alert("Error generating PNG: " + err.message);
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.innerText = "ğŸ“¸ Download Cards as PNG";
    }
  });

  // Initialize
  addColorPickers();
  loadCardColors();
});
<!-- === ğŸ§® SRF Weight Calculation & Save === -->

document.addEventListener("DOMContentLoaded", () => {
  const saveBtn = document.getElementById("saveBtn");
  const summary = document.getElementById("summaryTable");
  const board = document.getElementById("board");

  // ğŸ” Gather order + groups from the visual board
  function getRankingData() {
    const items = [...board.children];
    const order = [];
    const groups = [];

    items.forEach(el => {
      if (el.classList.contains("white-card")) {
        order.push("gap");
      } else if (el.classList.contains("group-card")) {
        const groupIds = [...el.querySelectorAll(".srf-card")].map(c => c.dataset.id);
        order.push(...groupIds);
        groups.push(groupIds);
      } else if (el.classList.contains("srf-card")) {
        order.push(el.dataset.id);
        groups.push([el.dataset.id]);
      }
    });

    return { order, groups };
  }

  // ğŸ“Š Compute SRF-style weights
  function computeWeights(order, groups) {
    let score = 1;
    const scores = [];
    const resultIds = [];

    for (let i = 0; i < order.length; i++) {
      const item = order[i];
      if (item === "gap") {
        score += 1; // each white card adds a gap
        continue;
      }
      scores.push(score);
      resultIds.push(item);
      if (order[i + 1] !== "gap" && order[i + 1] !== undefined) {
        score += 1;
      }
    }

    const total = scores.reduce((a, b) => a + b, 0);
    const weights = {};
    resultIds.forEach((id, i) => {
      weights[id] = (scores[i] / total).toFixed(4);
    });
    return weights;
  }

  // ğŸ§¾ Display weights with indicator names
  function renderSummary(weights) {
    const rows = Object.entries(weights)
      .map(([id, w]) => {
        const card = document.querySelector(`.srf-card[data-id="${id}"]`);
        const name = card ? card.querySelector("h6").innerText : `Indicator ${id}`;
        return `<tr><td>${name}</td><td>${w}</td></tr>`;
      })
      .join("");

    summary.innerHTML = `
      <h6 class="mb-2">ğŸ“Š Computed SRF Weights</h6>
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr><th>Indicator</th><th>Weight</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p class="text-muted small mt-2">
        Total = 1.0000 (normalized). Higher weight â†’ higher importance.
      </p>
    `;
  }

  // ğŸ’¾ Save & compute weights
  saveBtn.addEventListener("click", () => {
    const { order, groups } = getRankingData();
    const weights = computeWeights(order, groups);
    renderSummary(weights);

    fetch("{% url 'indicator_ranking_view' project.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ order, groups }),
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("âœ… SRF weights calculated and saved successfully!");
        } else {
          alert("âš ï¸ Error saving weights: " + data.message);
        }
      })
      .catch(err => alert("âŒ Network error: " + err));
  });
});


</script>

{% endblock %}
