{% extends "base.html" %}
{% load dict_utils %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Workshop 5 — Scenario Building</h2>
            <p class="text-muted mb-0">Stage 4: Scenario Extraction, Reporting, and Analytics</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'scenario_qsort' project.id %}" class="btn btn-outline-secondary">
                ← Back to Q-Sorting
            </a>
            <form method="post" class="d-inline ms-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    Recalculate Scenarios
                </button>
            </form>
        </div>
    </div>

    {% if not scenarios %}
    <div class="alert alert-info shadow-sm">
        No scenarios generated yet. Please click <strong>Recalculate Scenarios</strong> to process the data.
    </div>
    {% else %}

    <div id="scenarios-container" class="row g-4">
        {% for scenario in scenarios %}
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-dark text-white fw-bold">
                    {{ scenario.title }}
                </div>
                <div class="card-body">
                    <p class="small text-secondary white-space-pre-line mb-4">{{ scenario.description }}</p>

                    <h6 class="border-bottom pb-2 mb-3 text-primary">Top Preferred Actions</h6>
                    <ul class="list-group list-group-flush mb-4">
                        {% for obj in scenario.top_actions_objects %}
                            <li class="list-group-item px-0 py-2 small border-0">
                                <span class="badge bg-primary rounded-pill me-2">{{ forloop.counter }}</span>
                                {{ obj.text }}
                            </li>
                        {% endfor %}
                    </ul>

                    <h6 class="border-bottom pb-2 mb-3 text-secondary">Full Ranking</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle small mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Action</th>
                                    <th class="text-end" style="width: 80px;">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in scenario.ranking %}
                                <tr>
                                    <td class="text-truncate" style="max-width: 150px;" title="{{ row.text }}">
                                        {{ row.text }}
                                    </td>
                                    <td class="text-end">
                                        <div class="d-flex align-items-center justify-content-end">
                                            <span class="me-2 fw-bold">{{ row.score|floatformat:2 }}</span>
                                            <div class="progress" style="width: 40px; height: 4px;">
                                                <div class="progress-bar bg-info"
                                                     style="width: {{ row.score|add:3|default:0|floatformat:0 }}0%">
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-center text-muted">No ranking data available</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if analysis %}
    <div class="mt-5 pt-4 border-top">
        <h4 class="mb-4">Methodology Analytics</h4>

        <div class="row g-4">
            {% if analysis.scenario_correlation %}
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title fw-bold">Correlation Between Scenarios</h6>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-bordered small">
                                <thead class="table-light">
                                    <tr>
                                        <th>Scenario</th>
                                        {% for label in analysis.scenario_correlation.labels %}
                                            <th class="text-end">{{ label }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in analysis.scenario_correlation.matrix %}
                                    <tr>
                                        <td class="fw-bold">{{ analysis.scenario_correlation.labels|list_get:forloop.counter0 }}</td>
                                        {% for value in row %}
                                            <td class="text-end {% if value > 0.7 %}table-success{% elif value < -0.3 %}table-danger{% endif %}">
                                                {{ value|floatformat:3 }}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if analysis.factor_analysis %}
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title fw-bold">Rotated Factor Loadings</h6>
                        <p class="small text-muted mb-3">
                            Factors (Kaiser > 1): <strong>{{ analysis.factor_analysis.n_factors }}</strong>
                        </p>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered small text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-start">Participant</th>
                                        {% for _ in analysis.factor_analysis.rotated_loadings|list_get:0 %}
                                            <th>F{{ forloop.counter }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in analysis.factor_analysis.rotated_loadings %}
                                    <tr>
                                        <td class="text-start">{{ analysis.factor_analysis.participants|list_get:forloop.counter0 }}</td>
                                        {% for value in row %}
                                            <td class="{% if value > 0.45 or value < -0.45 %}table-warning fw-bold{% endif %}">
                                                {{ value|floatformat:3 }}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="mt-5 mb-5">
        <button id="download-pdf" class="btn btn-success">
            Download PDF Summary
        </button>
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('download-pdf');
    if (!btn) return;

    btn.addEventListener('click', function () {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        doc.setFontSize(16);
        doc.text('Scenario Building Summary', 10, y);
        y += 10;
        doc.setFontSize(11);

        const cards = document.querySelectorAll('#scenarios-container .card');
        cards.forEach((card) => {
            if (y > 260) { doc.addPage(); y = 20; }

            // Get Title
            const title = card.querySelector('.card-header').innerText;
            doc.setFont(undefined, 'bold');
            doc.text(title, 10, y);
            y += 7;

            // Get Description
            doc.setFont(undefined, 'normal');
            const desc = card.querySelector('.card-body p').innerText;
            const splitDesc = doc.splitTextToSize(desc, 180);
            doc.text(splitDesc, 10, y);
            y += (splitDesc.length * 5) + 5;

            // Get Top Actions
            const topActions = card.querySelectorAll('ul li');
            if(topActions.length > 0) {
                doc.text('Top Actions:', 10, y);
                y += 6;
                topActions.forEach(li => {
                    let text = li.innerText.replace(/^\d+\s*/, '').trim();
                    doc.text('• ' + text, 15, y);
                    y += 6;
                });
            }
            y += 10;
        });

        doc.save('scenarios.pdf');
    });
});
</script>

<style>
    .white-space-pre-line { white-space: pre-line; }
</style>
{% endblock %}