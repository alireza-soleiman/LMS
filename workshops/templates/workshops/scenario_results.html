{% extends "base.html" %}
{% load dict_utils %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Workshop 5 â€” Scenario Building</h2>
            <p class="text-muted mb-0">Stage 4: Analytics Dashboard & Reporting</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'scenario_correlation' project.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Correlation
            </a>

            <form method="post" class="d-inline ms-2">
                {% csrf_token %}
                <input type="hidden" name="mode" value="recalculate">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-cpu"></i> Recalculate
                </button>
            </form>

            <div class="btn-group ms-2">
                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> Export
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="mode" value="export_csv">
                            <button type="submit" class="dropdown-item">Download CSV Data</button>
                        </form>
                    </li>
                    <li><button class="dropdown-item" id="btn-pdf">Download PDF Report</button></li>
                </ul>
            </div>
        </div>
    </div>

    {% if not scenarios %}
    <div class="alert alert-info shadow-sm p-4">
        <h5>Ready to Analyze</h5>
        <p class="mb-0">Click <strong>Recalculate</strong> to generate scenarios.</p>
    </div>
    {% else %}

    <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">Dashboard</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button">Detailed Rankings</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">Methodology Stats</button>
        </li>
    </ul>

    <div class="tab-content" id="reportTabsContent">

        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div class="row g-4">
                {% for scenario in scenarios %}
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-top border-4 border-primary">
                        <div class="card-body">
                            <h5 class="card-title fw-bold">{{ scenario.title }}</h5>
                            <span class="badge bg-light text-dark border mb-3">
                                <i class="bi bi-people"></i> {{ scenario.count }} Participants
                            </span>
                            <p class="small text-muted">{{ scenario.description }}</p>

                            <h6 class="text-primary mt-3">Top Priorities:</h6>
                            <ul class="list-group list-group-flush small">
                                {% for obj in scenario.top_actions_objects %}
                                <li class="list-group-item px-0">
                                    <span class="fw-bold me-2">{{ forloop.counter }}.</span> {{ obj.text }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white fw-bold">
                            <i class="bi bi-ui-checks-grid"></i> Comparative Priorities (Top Actions of Scenario 1)
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40%;">Action</th>
                                            {% for s in scenarios %}
                                                <th class="text-center">{{ s.title }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for obj in scenarios.0.top_actions_objects|slice:":5" %}
                                        <tr>
                                            <td class="fw-bold text-secondary">{{ obj.text }}</td>
                                            {% for s in scenarios %}
                                                {% with str_id=obj.id|stringformat:"s" %}
                                                {% with score=s.composite_scores|dict_get:str_id|default:0 %}
                                                <td class="text-center">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <span class="small fw-bold mb-1">{{ score|floatformat:2 }}</span>
                                                        <div class="progress" style="width: 100px; height: 10px; background-color: #e9ecef;">
                                                            <div class="progress-bar {% if score >= 0 %}bg-success{% else %}bg-danger{% endif %}"
                                                                 role="progressbar"
                                                                 style="width: {{ score|add:3|div:6|mul:100|floatformat:0 }}%;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                {% endwith %}
                                                {% endwith %}
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="details" role="tabpanel">
            <div class="row g-4">
                {% for scenario in scenarios %}
                <div class="col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header fw-bold text-center bg-light">
                            {{ scenario.title }} Ranking
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 600px;">
                                <table class="table table-sm table-hover small mb-0 table-striped">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Action</th>
                                            <th class="text-end">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in scenario.ranking %}
                                        <tr>
                                            <td>{{ row.text }}</td>
                                            <td class="text-end fw-bold {% if row.score > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ row.score|floatformat:2 }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="analytics" role="tabpanel">
            <div class="row g-4">

                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header fw-bold">Factor Loadings (Rotated)</div>
                        <div class="card-body">
                            {% if analysis.factor_analysis %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered small text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-start">Participant</th>
                                                {% for _ in analysis.factor_analysis.rotated_loadings|list_get:0 %}
                                                    <th>F{{ forloop.counter }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in analysis.factor_analysis.rotated_loadings %}
                                            <tr>
                                                <td class="text-start fw-bold text-muted">{{ analysis.factor_analysis.participants|list_get:forloop.counter0 }}</td>
                                                {% for value in row %}
                                                    {# COLOR LOGIC: Green background if loading > 0.45 #}
                                                    <td class="{% if value > 0.45 %}bg-success text-white fw-bold{% endif %}">
                                                        {{ value|floatformat:2 }}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No factor analysis data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header fw-bold">Scenario Correlation</div>
                        <div class="card-body">
                            {% if analysis.scenario_correlation %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered small text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th></th>
                                                {% for label in analysis.scenario_correlation.labels %}
                                                    <th class="text-end">{{ label }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in analysis.scenario_correlation.matrix %}
                                            <tr>
                                                <td class="fw-bold text-start">{{ analysis.scenario_correlation.labels|list_get:forloop.counter0 }}</td>
                                                {% for value in row %}
                                                    {# COLOR LOGIC: Green Text for > 0.7, Red for < -0.5 #}
                                                    <td class="text-end
                                                        {% if value > 0.7 %}text-success fw-bold
                                                        {% elif value < -0.5 %}text-danger fw-bold
                                                        {% endif %}">
                                                        {{ value|floatformat:2 }}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No correlation data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnPdf = document.getElementById('btn-pdf');
    if (btnPdf) {
        btnPdf.addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Workshop 5 Scenario Report', 10, 10);

            let y = 20;
            document.querySelectorAll('#dashboard .card-title').forEach(t => {
                doc.text(t.innerText, 10, y);
                y += 10;
            });
            doc.save('scenarios.pdf');
        });
    }
});
</script>
{% endblock %}