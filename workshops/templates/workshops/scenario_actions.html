{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Workshop 5 â€” Stage 1: Define Actions</h2>
            <p class="text-muted mb-0">Add actions one by one. Edit or delete them using the buttons below.</p>
        </div>
        {% if actions %}
        <a href="{% url 'scenario_qsort' project.id %}" class="btn btn-primary">
            Go to Stage 2 (Q-Sorting) &rarr;
        </a>
        {% else %}
        <button class="btn btn-secondary" disabled>Go to Stage 2 (Add actions first)</button>
        {% endif %}
    </div>

    <div class="card mb-4 shadow-sm border-primary">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-plus-lg me-1"></i> Add New Action
        </div>
        <div class="card-body">
            <form method="post" class="row g-2">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="add">
                <div class="col-md-10">
                    <input type="text" name="new_action" class="form-control"
                           placeholder="Enter a new action sentence..." required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            Existing Actions ({{ actions|length }})
        </div>
        <div class="card-body p-0">
            {% if not actions %}
                <div class="text-center p-5 text-muted">
                    <p class="mb-0">No actions defined yet.</p>
                </div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;" class="text-center">ID</th>
                                <th>Action Text</th>
                                <th style="width: 180px;" class="text-end">Options</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for action in actions %}
                            <tr>
                                <td class="text-center text-muted fw-bold">{{ action.id }}</td>
                                <td>{{ action.text }}</td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary me-1"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            data-id="{{ action.id }}"
                                            data-text="{{ action.text }}">
                                        Edit
                                    </button>

                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal"
                                            data-id="{{ action.id }}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action_type" value="edit_single">
        <input type="hidden" name="action_id" id="edit-id-input">

        <div class="modal-header">
          <h5 class="modal-title">Edit Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Action Text:</label>
          <textarea name="action_text" id="edit-text-input" class="form-control" rows="3" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action_type" value="delete">
        <input type="hidden" name="action_id" id="delete-id-input">

        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this action?</p>
          <p class="small text-muted">This cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    // Logic to pass data into the EDIT Modal
    var editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget;
        // Extract info from data-* attributes
        var id = button.getAttribute('data-id');
        var text = button.getAttribute('data-text');

        // Update the modal's content
        var idInput = editModal.querySelector('#edit-id-input');
        var textInput = editModal.querySelector('#edit-text-input');

        idInput.value = id;
        textInput.value = text;
    });

    // Logic to pass data into the DELETE Modal
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var id = button.getAttribute('data-id');

        var idInput = deleteModal.querySelector('#delete-id-input');
        idInput.value = id;
    });
});
</script>
{% endblock %}