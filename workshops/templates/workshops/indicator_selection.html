{# templates/workshops/indicator_selection.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h2>WS3 — Indicator Selection (Delphi) — Project: {{ project.title }}</h2>

  <div class="row">
    <div class="col-md-7">
      <h5>Available Indicators</h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Accept</th>
            <th>Indicator</th>
            <th>Description</th>
            <th>Added By</th>
          </tr>
        </thead>
        <tbody>
          {% for ind in indicators %}
          <tr id="ind-row-{{ ind.id }}">
            <td>
              <input type="checkbox" class="form-check-input accept-checkbox" data-id="{{ ind.id }}" {% if ind.accepted %}checked{% endif %}>
            </td>
            <td>{{ ind.name }}</td>
            <td>{{ ind.description|default:"—" }}</td>
            <td>{% if ind.added_by_student %}Student{% else %}Provided{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">No indicators yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-3">
        <a href="{% url 'indicator_ranking' project.id %}" class="btn btn-primary">Proceed to Ranking (SRF)</a>
        <a href="{% url 'workshop_list' %}" class="btn btn-light">Back to Workshops</a>
      </div>
    </div>

    <div class="col-md-5">
      <h5>Add a custom indicator</h5>
      <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="mb-2">
          {{ form.name.label_tag }}
          {{ form.name }}
          {{ form.name.errors }}
        </div>
        <div class="mb-2">
          {{ form.description.label_tag }}
          {{ form.description }}
          {{ form.description.errors }}
        </div>
        <div class="form-check mb-2">
          {{ form.accepted }}
          {{ form.accepted.label_tag }}
        </div>
        <button type="submit" name="add_indicator" class="btn btn-success">Add Indicator</button>
      </form>

      <hr>
      <h6>Notes</h6>
      <p>Phase 1: use the checkboxes to mark 'Accepted' indicators. When finished click "Proceed to Ranking".</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.accept-checkbox');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      const id = this.dataset.id;
      fetch("{% url 'toggle_indicator_accept' 0 %}".replace('/0/', '/' + id + '/'), {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Accept': 'application/json',
        },
      }).then(r => r.json()).then(data => {
        if (data.status !== 'success') {
          alert('Error toggling indicator: ' + (data.message || 'unknown'));
        }
      }).catch(err => {
        console.error(err);
        alert('Network error toggling indicator.');
      });
    });
  });
});
</script>

{% endblock %}
