{% extends "base.html" %}
{% load static %}

{% block title %}Indicator Selection — {{ project.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">WS3 — Indicator Selection (Delphi)</h2>
  <p class="text-muted">
    Browse indicators by category. Select up to <strong>15</strong> indicators that fit your project.
  </p>

  <!-- Search bar -->
  <input type="text" id="searchBox" class="form-control mb-3" placeholder="Search indicator name, criterion, or description...">

  <!-- Accordion by category -->
  <div class="accordion" id="indicatorAccordion">
    {% regroup indicators by category as category_list %}
    {% for cat in category_list %}
      <div class="accordion-item mb-2">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                  aria-controls="collapse{{ forloop.counter }}">
            {{ cat.grouper|default:"Uncategorized" }}
          </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#indicatorAccordion">
          <div class="accordion-body p-0">
            <table class="table table-striped align-middle m-0">
              <thead class="table-dark">
                <tr>
                  <th style="width:70px;">Accept</th>
                  <th>Indicator</th>
                  <th>Criterion</th>
                  <th>Description</th>
                  <th>Unit</th>
                </tr>
              </thead>
              <tbody>
                {% for ind in cat.list %}
                  <tr>
                    <td class="text-center">
                      <input type="checkbox" {% if ind.accepted %}checked{% endif %}
                             onchange="toggleAccept({{ ind.id }}, this.checked)">
                    </td>
                    <td>{{ ind.name }}</td>
                    <td>{{ ind.criterion }}</td>
                    <td>{{ ind.description|truncatewords:25 }}</td>
                    <td>{{ ind.unit }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No indicators found.</p>
    {% endfor %}
  </div>

  <hr class="my-4">
  <h5>Add a Custom Indicator</h5>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="add_indicator" class="btn btn-primary">Add Indicator</button>
  </form>

  <div class="mt-4">
    <a href="{% url 'indicator_ranking' project.id %}" class="btn btn-success">Proceed to SRF Ranking →</a>
  </div>
</div>

<script>
function toggleAccept(indicatorId, isChecked) {
  fetch(`/workshops/indicator/toggle/${indicatorId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ accepted: isChecked })
  });
}

// Live search filter
document.getElementById('searchBox').addEventListener('keyup', function() {
  const search = this.value.toLowerCase();
  document.querySelectorAll('#indicatorAccordion table tbody tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(search) ? '' : 'none';
  });
});
</script>
{% endblock %}
