{% extends "base.html" %}
{% load static %}
{% load string_extras %}


{% block title %}Indicator Selection â€” {{ project.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">WS3 â€” Indicator Selection (Delphi)</h2>
  <p class="text-muted">
    Browse indicators by category. Select up to <strong>15</strong> indicators that fit your project.
  </p>

  <!-- Search bar -->
  <input type="text" id="searchBox" class="form-control mb-3" placeholder="Search indicator name, criterion, or description...">

<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <h5 class="card-title">Selected Indicators Summary</h5>

    <!-- Counter + Progress bar -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <small class="text-muted">Selected: <span id="selectedCount">0</span> / 15</small>
      <button class="btn btn-primary btn-sm" id="saveSelectionsBtn">ðŸ’¾ Save Selections</button>
    </div>
    <div class="progress mb-3" style="height: 8px;">
      <div id="selectionProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%;"></div>
    </div>

    <!-- Selected table -->
    <table class="table table-sm table-bordered mb-0" id="selectedTable" style="display:none;">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Criterion</th>
          <th>Unit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  <!-- Nested accordion view -->
    <div class="accordion" id="mainAccordion">
  {% for main_token, main in hierarchy.items %}
  <div class="accordion-item mb-2">
    <h2 class="accordion-header" id="headingMain{{ forloop.counter }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMain{{ forloop.counter }}">
        {{ main.full }}
      </button>
    </h2>
    <div id="collapseMain{{ forloop.counter }}" class="accordion-collapse collapse">
      <div class="accordion-body">

        <!-- Subcategory accordion inside -->
        <div class="accordion" id="subAccordion{{ forloop.counter }}">
          {% for sub_token, sub in main.subs.items %}
          <div class="accordion-item mb-1">
            <h2 class="accordion-header" id="headingSub{{ forloop.parentloop.counter }}{{ forloop.counter }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSub{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                {{ sub.full }}
              </button>
            </h2>
            <div id="collapseSub{{ forloop.parentloop.counter }}{{ forloop.counter }}" class="accordion-collapse collapse">
              <div class="accordion-body p-0">
                {% if sub.indicators %}
                <table class="table table-striped m-0">
                  <thead class="table-dark">
                    <tr>
                      <th style="width:70px;">Accept</th>
                      <th>Indicator</th>
                      <th>Criterion</th>
                      <th>Description</th>
                      <th>Unit</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ind in sub.indicators %}
                    <tr>
                      <td class="text-center">
                        <input type="checkbox" data-id="{{ ind.id }}" {% if ind.accepted %}checked{% endif %} onchange="toggleAccept({{ ind.id }}, this.checked)">
                      </td>
                      <td>{{ ind.name }}</td>
                      <td>{{ ind.criterion }}</td>
                      <td>{{ ind.description|truncatewords:25 }}</td>
                      <td>{{ ind.unit }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <div class="px-3 py-2 text-muted">No indicators under this subcategory.</div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

  <hr class="my-4">
  <h5>Add a Custom Indicator</h5>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="add_indicator" class="btn btn-primary">Add Indicator</button>
  </form>

  <div class="mt-4">
    <a href="{% url 'indicator_ranking' project.id %}" class="btn btn-success">Proceed to SRF Ranking â†’</a>
  </div>
</div>

<script>
function toggleAccept(indicatorId, isChecked) {
  fetch(`/workshops/indicator/toggle/${indicatorId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ accepted: isChecked })
  });
}

// Live search filter
document.getElementById('searchBox').addEventListener('keyup', function() {
  const search = this.value.toLowerCase();
  document.querySelectorAll('#indicatorAccordion table tbody tr').forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(search) ? '' : 'none';
  });
});
</script>

{% endblock %}
