{% extends "base.html" %}
{% load static %}
{% load string_extras %}

{% block title %}Indicator Selection ‚Äî {{ project.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-3">WS3 ‚Äî Indicator Selection (Delphi)</h2>
  <p class="text-muted">
    Browse indicators by category. Select up to <strong>15</strong> indicators that fit your project.
  </p>

  <!-- Summary panel -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="card-title mb-0">Selected Indicators Summary</h5>
        <button class="btn btn-primary btn-sm" id="saveSelectionsBtn">üíæ Save Selections</button>
      </div>

      <div class="text-muted small mb-2">
        Your selections are saved locally ‚Äî click ‚ÄúSave Selections‚Äù to finalize.
      </div>

      <!-- Counter + Progress bar -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <small class="text-muted">Selected: <span id="selectedCount">0</span> / 15</small>
      </div>

      <div class="progress mb-3" style="height: 8px;">
        <div id="selectionProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%;"></div>
      </div>

      <!-- Selected table -->
      <table class="table table-sm table-bordered mb-0" id="selectedTable" style="display:none;">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Criterion</th>
            <th>Unit</th>
            <th style="width:40px;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Nested accordion view -->
  <div class="accordion" id="mainAccordion">
    {% for main_token, main in hierarchy.items %}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="headingMain{{ forloop.counter }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseMain{{ forloop.counter }}">
          {{ main.full }}
        </button>
      </h2>
      <div id="collapseMain{{ forloop.counter }}" class="accordion-collapse collapse">
        <div class="accordion-body">

          <!-- Subcategory accordion inside -->
          <div class="accordion" id="subAccordion{{ forloop.counter }}">
            {% for sub_token, sub in main.subs.items %}
            <div class="accordion-item mb-1">
              <h2 class="accordion-header" id="headingSub{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseSub{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                  {{ sub.full }}
                </button>
              </h2>
              <div id="collapseSub{{ forloop.parentloop.counter }}{{ forloop.counter }}" class="accordion-collapse collapse">
                <div class="accordion-body p-0">
                  {% if sub.indicators %}
                  <table class="table table-striped m-0">
                    <thead class="table-dark">
                      <tr>
                        <th style="width:70px;">Accept</th>
                        <th>Indicator</th>
                        <th>Criterion</th>
                        <th>Description</th>
                        <th>Unit</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for ind in sub.indicators %}
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" data-id="{{ ind.id }}" {% if ind.accepted %}checked{% endif %}>
                        </td>
                        <td>{{ ind.name }}</td>
                        <td>{{ ind.criterion }}</td>
                        <td>{{ ind.description|truncatewords:25 }}</td>
                        <td>{{ ind.unit }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  {% else %}
                  <div class="px-3 py-2 text-muted">No indicators under this subcategory.</div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <hr class="my-4">
  <h5>Add a Custom Indicator</h5>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="add_indicator" class="btn btn-primary">Add Indicator</button>
  </form>

  <div class="mt-4">
    <a href="{% url 'indicator_ranking' project.id %}" class="btn btn-success">Proceed to SRF Ranking ‚Üí</a>
  </div>
</div>

<!-- ‚úÖ JS Section -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const checkboxes = document.querySelectorAll("input[type=checkbox][data-id]");
  const selectedTable = document.getElementById("selectedTable");
  const selectedBody = selectedTable.querySelector("tbody");
  const selectedCount = document.getElementById("selectedCount");
  const progressBar = document.getElementById("selectionProgress");
  const saveBtn = document.getElementById("saveSelectionsBtn");
  const maxSelect = 15;

  let selectedIndicators = new Map();

  // üîÑ Load from localStorage
  const saved = localStorage.getItem("selectedIndicators");
  if (saved) {
    selectedIndicators = new Map(Object.entries(JSON.parse(saved)));
    updateUIFromCache();
  }

  // ‚úÖ Checkbox handling
  checkboxes.forEach(cb => {
    cb.addEventListener("change", () => {
      const id = cb.dataset.id;
      const row = cb.closest("tr");
      const name = row.children[1].innerText;
      const crit = row.children[2].innerText;
      const unit = row.children[4].innerText;

      if (cb.checked) {
        if (selectedIndicators.size >= maxSelect) {
          alert("You can select up to 15 indicators only.");
          cb.checked = false;
          return;
        }
        selectedIndicators.set(id, { name, crit, unit });
      } else {
        selectedIndicators.delete(id);
      }

      persistAndUpdate();
    });
  });

  // ‚úÖ Update summary
  function updateSummary() {
    selectedBody.innerHTML = "";
    selectedIndicators.forEach((data, id) => {
      const row = `
        <tr data-id="${id}">
          <td>${data.name}</td>
          <td>${data.crit}</td>
          <td>${data.unit}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger remove-btn">‚úñ</button>
          </td>
        </tr>`;
      selectedBody.insertAdjacentHTML("beforeend", row);
    });

    const count = selectedIndicators.size;
    selectedCount.textContent = count;

    // üé® Progress color
    const percent = (count / maxSelect) * 100;
    progressBar.style.width = percent + "%";
    progressBar.classList.remove("bg-success", "bg-warning", "bg-danger");
    if (percent < 40) progressBar.classList.add("bg-success");
    else if (percent < 80) progressBar.classList.add("bg-warning");
    else progressBar.classList.add("bg-danger");

    selectedTable.style.display = count ? "table" : "none";
  }

  // ‚úÖ LocalStorage sync + UI update
  function persistAndUpdate() {
    localStorage.setItem("selectedIndicators", JSON.stringify(Object.fromEntries(selectedIndicators)));
    updateSummary();
  }

  // ‚úÖ Restore checkboxes on load
  function updateUIFromCache() {
    checkboxes.forEach(cb => {
      if (selectedIndicators.has(cb.dataset.id)) {
        cb.checked = true;
      }
    });
    updateSummary();
  }

  // ‚úÖ Remove button inside summary table
  selectedBody.addEventListener("click", e => {
    if (e.target.classList.contains("remove-btn")) {
      const tr = e.target.closest("tr");
      const id = tr.dataset.id;
      selectedIndicators.delete(id);
      const checkbox = document.querySelector(`input[type=checkbox][data-id="${id}"]`);
      if (checkbox) checkbox.checked = false;
      persistAndUpdate();
    }
  });

  // ‚úÖ Save button sends to backend
  const saveUrl = "{% url 'save_indicator_selections' project.id %}";
  saveBtn.addEventListener("click", () => {
    const ids = Array.from(selectedIndicators.keys());
    fetch(saveUrl, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ selected_ids: ids }),
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        alert(`Saved ${data.count} indicators successfully!`);
      } else {
        alert("Error saving selections.");
      }
    })
    .catch(() => alert("Network error."));
  });
});
</script>
{% endblock %}
